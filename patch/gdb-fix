#!/bin/sh

# Will patch all running qemu for CVE-2015-3456. No detection of
# vulnerable processes, all processes are patched. This is harmless
# for already patched processes as long as you don't need the FDC.

# Look for the command_to_handler symbol. Need the debug symbols.

(
    cat <<EOF""
define patch
  set $handler = sizeof(handlers)/sizeof(*handlers)-1
  set $i = 0
  while ($i < 256)
   set variable command_to_handler[$i++] = $handler
  end
  printf "Done!\n"
document patch
Hotfix CVE-2015-3456.
end
EOF
    for pid in $(pidof qemu-system-x86_64); do
        cat <<EOF
attach $pid
printf "Handling PID %d\n", $pid
patch
detach
EOF
    done
) > CVE-2015-3456.gdb
gdb --batch --command=CVE-2015-3456.gdb $(which qemu-system-x86_64)
